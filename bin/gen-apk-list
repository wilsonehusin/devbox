#!/usr/bin/env bash

set -euo pipefail

ARCH=${ARCH:-$(uname -m)}
APK_URL=${APK_URL:-https://packages.wolfi.dev/os/$ARCH/APKINDEX.tar.gz}
LISTFILE="apk-${ARCH}.list"

printf "Using $(tput setaf 6)$(tput bold)%s$(tput sgr0)...\n" "${APK_URL}"

APK_ARCHIVE=${APK_ARCHIVE:-apkindex.tar.gz}

curl -LSso "${APK_ARCHIVE}" "${APK_URL}"
tar -xzvf "${APK_ARCHIVE}" -C tmp APKINDEX &>/dev/null
rm -f ${APK_ARCHIVE}

grep -Eo '^o:(.*)$' tmp/APKINDEX | cut -d ':' -f 2 | sort | uniq > "${LISTFILE}"

COUNT=$(wc -l < "${LISTFILE}")
printf "Found $(tput setaf 4)$(tput bold)%s packages$(tput sgr0) in $(tput setaf 3)%s$(tput sgr0)\n" "${COUNT}" "${LISTFILE}"

printf "\n# Source: %s\n# Generated %s\n" "${APK_URL}" $(date --utc --iso-8601=seconds) >> "${LISTFILE}"
printf "$(tput bold)Done!$(tput sgr0)\n"
